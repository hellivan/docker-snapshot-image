version: 2.1

aliases:
  - &job-defaults
      docker:
        - image: circleci/node:12.13.0
      working_directory: ~/repo
  - &attach_workspace
      attach_workspace:
        at: ~/

jobs:
  setup:
    <<: *job-defaults
    steps:
      - checkout
      - run:
          command: yarn install --frozen-lockfile --non-interactive
      - persist_to_workspace:
          root: ~/
          paths:
            - ./repo

  build:
    <<: *job-defaults
    steps:
      - *attach_workspace
      - run:
          command: yarn build
      - persist_to_workspace:
          root: ~/
          paths:
            - ./repo/dist

  lint:
    <<: *job-defaults
    steps:
      - *attach_workspace
      - run:
          command: yarn lint

  check-dependencies:
    <<: *job-defaults
    steps:
      - *attach_workspace
      - run:
          command: yarn check-dependencies

  check-formatting:
    <<: *job-defaults
    steps:
      - *attach_workspace
      - run:
          command: yarn check-formatting

  release:
    <<: *job-defaults
    steps:
      - *attach_workspace
      - run:
          command: yarn semantic-release

workflows:
  version: 2
  install-test-build-and-publish:
    jobs:
      - setup
      - build:
          requires:
            - setup
      - lint:
          requires:
            - setup
      - check-dependencies:
          requires:
            - build
      - check-formatting:
          requires:
            - setup
      - release:
          filters:
            branches:
              only:
                - master
          requires:
            - build
            - lint
            - check-dependencies
            - check-formatting